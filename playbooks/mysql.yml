- name: Install MySQL server and Kafka connector
  hosts: all
  gather_facts: no
  vars_files:
  - variables.yml
  tasks:
  - name: Wait for server
    wait_for_connection:
      timeout: 360
    become: no

  - name: Install packages
    yum:
      name:
      - net-tools
      - mariadb-server
      - MySQL-python

  - name: Put MySQL config
    copy:
      src: server.cnf
      dest: /etc/my.cnf.d/
    register: my_cnf

  - name: Start MySQL service
    service:
      name: mariadb
      enabled: yes
      state: "{{ 'restarted' if my_cnf.changed else 'started' }}"

  - name: Add connector user
    mysql_user:
      name: "{{ connector_user }}"
      host: '%'
      password: "{{ connector_pass }}"
      priv: '*.*:SELECT,RELOAD,SHOW DATABASES,REPLICATION SLAVE,REPLICATION CLIENT'
